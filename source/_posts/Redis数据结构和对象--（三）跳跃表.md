title: Redis数据结构和对象-(三)跳跃表
tags: [缓存,Redis]
categories: [缓存,Redis]
date: 2016-09-24 14:32:02
---



## 定义:
它是一种有序数据结构,通过在每个节点中维持多个 指向其他节点
的指针,从而达到快速访问节点的目的。

## 使用场景:
Redis使用跳跃表作为有序集合键的底层实现之一,如果一个有序集合包含的元素数量比较多,又或者有序集合中元素的成(member)是比较长的字符串时,Redis就会使用跳跃表来作为有序集合键的底层实现。
另外,在集群节点中跳跃表被用作内部数据结构。除此之外在Redis中在无他用


## 实现:
跳跃表由zskiplistNode和zskiplist两个结构定义,其中zskiplistNode用
于表示跳跃表节点,而zskiplist用于保存跳跃表节点的相关信息。

![](/img/skipList-1.png)

上图为zskiplist结构,其中
- header指向跳跃表的表头节点。
- tail指向表尾节点。
- level记录层数最大的那个节点的层数(注意:表头节点的层数不计算在内),是1-32之间的一个随机数,越大的数出现的概率越小。

下图右为zskiplist结构,其中层(level):L1、L2、L3等标记各个节点的层,每个层都有前进指针和跨度,当程序从表头向表尾进行遍历时,访问会沿着层的前进指针进行。

**跨度**:层的跨度(level[i].span属性)用于记录两个节点间的距离,节点间的跨度越大,它们相聚的就越远,指向NULL的所有前进指针的跨度都为0,因为它们没有连向任何节点。跨度跟遍历操作无关,是用来计算排位的(可根据排位获取元素节点),如下图,查找分值为3.0、对象为o3的节点时,只经过了一个层,并且层的跨度为3,所以该节点在跳跃表中的排位为3。

![](/img/skipList-2.png)

- **后退(backward)指针**:BW标记节点的后退指针,它指向位于当前节点的前一个节点,后退指针在程序从表尾向表头遍历时使用,与前进指针不同,后退针每次只能后退至前一个节点,因为每个节点只有一个后退指针。
- **分值**(score):1.0、2.0和3.0是节点所保存的分值,分值是一个double类型的浮点数,可重复,用于节点排序(分值相同则按在字典中大小排)。
- **成员对象**(obj):o1、o2和o3是节点所保存的成员对象,成员对象是一个指针,它指向一个字符串对象,而字符串对象则保存着一个SDS值,并且是唯一的。
*注意:表头节点跟其他节点一样,也有后退指针、分值、成员对象等属性,但都不会被用到,故在图中没有画出。*

## 跳跃表API

![](/img/skipList-3.png)

## 补充
a.跳表具有如下性质:
1.  由很多层结构组成
1. 每一层都是一个有序的链表
1. 最底层(Level 1)的链表包含所有元素
1. 如果一个元素出现在 Level i 的链表中,则它在 Level i 之下的链表也都会出现。
1. 每个节点包含两个指针,一个指向同一链表中的下一个元素,一个指向下面一层的元素。

b.插入

先确定该元素要占据的层数 K(采用丢硬币的方式,这完全是随机的)
然后在 Level 1 ... Level K 各个层的链表都插入元素。
例子:插入 119, K = 2
![](/img/skipList-4.png)

如果 K 大于链表的层数,则要添加新的层。
例子:插入 119, K = 4
![](/img/skipList-5.png)

c.删除
三个步骤:
1. 在跳跃表中查找到这个元素的位置(如果未找到,则退出)
1. 将该元素所在整列从表中删除
1. 将多余的“空链”删除
![](/img/skipList-6.png)